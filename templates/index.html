{% extends "base.html" %}

{% block title %}Classificador IA{% endblock %}

{% block head_extra %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Chart Container */
        .chart-container {
            background-color: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(200, 200, 200, 0.5);
            border-radius: 0.5rem;
            padding: 1rem;
        }
        .dark .chart-container {
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(70, 70, 70, 0.4);
        }

        /* Tabs */
        .tab-button {
            border-radius: 0.5rem 0.5rem 0 0;
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: -1px;
        }
        /* Light Mode Tabs */
        .tab-active {
            z-index: 10;
            background-color: rgba(255, 255, 255, 0.5);
            border-top: 1px solid rgba(200, 200, 200, 0.3);
            border-left: 1px solid rgba(200, 200, 200, 0.3);
            border-right: 1px solid rgba(200, 200, 200, 0.3);
            color: #111827; /* gray-900 */
        }
        .tab-inactive {
            background-color: transparent;
            border-bottom: 1px solid rgba(200, 200, 200, 0.3);
            color: #4b5563; /* gray-600 */
        }
        .tab-inactive:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: #111827;
        }
        /* Dark Mode Tabs */
        .dark .tab-active {
            background-color: rgba(23, 23, 23, 0.6);
            border-top: 1px solid rgba(70, 70, 70, 0.4);
            border-left: 1px solid rgba(70, 70, 70, 0.4);
            border-right: 1px solid rgba(70, 70, 70, 0.4);
            color: #f9fafb; /* text-white */
        }
        .dark .tab-inactive {
            border-bottom: 1px solid rgba(70, 70, 70, 0.4);
            color: #9ca3af; /* text-gray-400 */
        }
        .dark .tab-inactive:hover {
            background-color: rgba(0, 0, 0, 0.1);
            color: #f9fafb;
        }

        /* Custom Scrollbar Styling */
        /* For Webkit Browsers */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        .dark ::-webkit-scrollbar-thumb { background: #4B5563; }
        ::-webkit-scrollbar-thumb { background: #9CA3AF; }
        ::-webkit-scrollbar-thumb:hover { background: #6B7280; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }
        /* For Firefox */
        * { scrollbar-width: thin; }
        * { scrollbar-color: #9CA3AF transparent; }
        .dark * { scrollbar-color: #4B5563 transparent; }
    </style>
{% endblock %}

{% block content %}
<div class="absolute top-6 right-6 z-30 flex items-center space-x-4">
    <span class="text-sm text-gray-600 dark:text-gray-300">Olá, {{ current_user.name }}</span>
    <a href="{{ url_for('logout') }}" class="text-sm text-blue-600 dark:text-blue-400 hover:underline">Sair</a>
</div>

<div class="w-full max-w-4xl" id="tilt-container">
    <div id="tilt-wrapper" class="relative" style="transform-style: preserve-3d;">
        
        <div class="flex space-x-1 pl-4 z-10 relative">
            <button data-tab="classifier" class="tab-button tab-active">Classificador</button>
            <button data-tab="dashboard" class="tab-button tab-inactive">Dashboard</button>
            <button data-tab="profile" class="tab-button tab-inactive">Perfil</button>
        </div>

        <div id="main-card-content" class="glassmorphism rounded-b-xl rounded-tr-xl relative z-0">
            <div class="overflow-y-auto" style="max-height: 85vh;">
                <div class="relative z-10 p-6 space-y-6">
                    <div id="tab-panels">
                        <!-- Painel do Classificador -->
                        <div data-panel="classifier" class="tab-panel space-y-6">
                            <form id="email-form" class="space-y-6">
                                <div class="space-y-2">
                                    <label for="email-text" class="text-sm font-medium leading-none text-black dark:text-white">Conteúdo do Email</label>
                                    <textarea id="email-text" rows="8" placeholder="Cole o conteúdo do email aqui..." class="flex w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-black/30 px-3 py-2 text-sm shadow-inner placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-black dark:text-white"></textarea>
                                </div>
                                <div class="relative">
                                    <div class="absolute inset-0 flex items-center"><span class="w-full border-t border-gray-300 dark:border-gray-600"></span></div>
                                    <div class="relative flex justify-center text-xs uppercase"><span class="px-2 text-gray-500 dark:text-gray-400 bg-gray-200/80 dark:bg-gray-800/80 backdrop-blur-sm">Ou</span></div>
                                </div>
                                <div class="space-y-2">
                                    <label for="email-file" class="text-sm font-medium leading-none text-black dark:text-white">Upload de Arquivo (.txt, .pdf)</label>
                                    <input type="file" id="email-file" accept=".txt,.pdf" class="flex h-10 w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-black/30 px-3 py-2 text-sm file:border-0 file:bg-blue-600 file:text-white file:rounded-md file:px-3 file:py-1 file:text-sm file:font-medium file:hover:bg-blue-700 file:cursor-pointer placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-black dark:text-white cursor-pointer">
                                </div>
                                <button type="submit" id="submit-button" class="inline-flex items-center justify-center rounded-md text-sm font-medium h-10 px-4 py-2 w-full bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                                    Classificar Email
                                </button>
                            </form>
                            <div class="border-t border-gray-200 dark:border-gray-700/50 pt-4 space-y-4">
                                <div id="loading" class="hidden flex flex-col items-center justify-center space-y-2">
                                    <div class="w-8 h-8 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Analisando com a IA...</p>
                                </div>
                                <div id="error-message" class="hidden border border-red-400/50 text-red-700 bg-red-100/50 dark:border-red-500/50 dark:text-red-300 dark:bg-red-900/30 rounded-md p-4 text-sm"></div>
                                <div id="result-container" class="hidden space-y-4">
                                    <h2 class="text-xl font-semibold tracking-tight text-black dark:text-white">Resultado da Análise</h2>
                                    <div class="space-y-2">
                                        <strong class="text-sm font-medium text-black dark:text-white">Categoria:</strong>
                                        <span id="result-category"></span> 
                                    </div>
                                    <div class="space-y-2">
                                        <strong class="text-sm font-medium text-black dark:text-white">Resposta Sugerida:</strong>
                                        <p id="result-response" class="text-sm p-4 rounded-md bg-white/50 dark:bg-black/30 border border-gray-300 dark:border-gray-600 text-black dark:text-white whitespace-pre-wrap"></p>
                                    </div>
                                    <div class="border-t border-gray-200 dark:border-gray-700/50 pt-4 space-y-4">
                                        <h3 class="text-lg font-semibold text-black dark:text-white">Enviar Resposta</h3>
                                        <div class="space-y-2">
                                            <label for="recipient-email" class="text-sm font-medium leading-none text-black dark:text-white">Email do Destinatário:</label>
                                            <input type="email" id="recipient-email" placeholder="cliente@email.com" class="flex w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-black/30 px-3 py-2 text-sm shadow-inner placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-black dark:text-white">
                                        </div>
                                        <button id="send-email-button" class="inline-flex items-center justify-center rounded-md text-sm font-medium h-10 px-4 py-2 w-full bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                            Enviar Email Diretamente
                                        </button>
                                        <p id="send-status" class="text-sm text-center mt-2 h-4"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Painel do Dashboard -->
                        <div data-panel="dashboard" class="tab-panel hidden space-y-6">
                            <h2 class="text-2xl font-semibold tracking-tight text-black dark:text-white">Estatísticas de Uso</h2>
                            <div id="dashboard-loading" class="flex flex-col items-center justify-center space-y-2 h-64">
                                <div class="w-8 h-8 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Buscando dados...</p>
                            </div>
                            <div id="dashboard-content" class="hidden space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="chart-container"><canvas id="chart-mes"></canvas></div>
                                    <div class="chart-container"><canvas id="chart-categoria"></canvas></div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="chart-container md:col-span-2"><canvas id="chart-dia"></canvas></div>
                                    <div class="chart-container flex flex-col items-center justify-center">
                                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">Emails Enviados</span>
                                        <span id="sent-count-kpi" class="text-5xl font-bold text-black dark:text-white">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Painel de Perfil -->
                        <div data-panel="profile" class="tab-panel hidden space-y-8">
                            <h2 class="text-2xl font-semibold tracking-tight text-black dark:text-white">Configurações de Perfil</h2>

                            {% with messages = get_flashed_messages(with_categories=true) %}
                                {% if messages %}
                                    {% for category, message in messages %}
                                        <div class="p-3 rounded-md text-sm {{ 'bg-green-100 text-green-800 border-green-300 dark:bg-green-900/50 dark:text-green-300 dark:border-green-700' if category == 'success' else 'bg-red-100 text-red-800 border-red-300 dark:bg-red-900/50 dark:text-red-300 dark:border-red-700' }}">
                                            {{ message }}
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            {% endwith %}

                            <!-- Formulário de Dados Pessoais -->
                            <div class="border-t border-gray-200 dark:border-gray-700/50 pt-6">
                                <h3 class="text-lg font-semibold text-black dark:text-white mb-4">Dados Pessoais</h3>
                                <form method="POST" action="{{ url_for('profile') }}" class="space-y-4 max-w-md">
                                    <input type="hidden" name="action" value="update_profile">
                                    <div>
                                        <label for="name" class="block mb-2 text-sm font-medium text-black dark:text-white">Nome</label>
                                        <input type="text" name="name" id="name" value="{{ current_user.name }}" class="flex w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-black/30 px-3 py-2 text-sm shadow-inner placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-black dark:text-white" required>
                                    </div>
                                    <div>
                                        <label for="email" class="block mb-2 text-sm font-medium text-black dark:text-white">Email</label>
                                        <input type="email" name="email" id="email" value="{{ current_user.email }}" class="flex w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-black/30 px-3 py-2 text-sm shadow-inner placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-black dark:text-white" required>
                                    </div>
                                    <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium h-10 px-4 py-2 bg-blue-600 text-white hover:bg-blue-700">Salvar Alterações</button>
                                </form>
                            </div>

                            <!-- Formulário de Alterar Senha -->
                            <div class="border-t border-gray-200 dark:border-gray-700/50 pt-6">
                                <h3 class="text-lg font-semibold text-black dark:text-white mb-4">Alterar Senha</h3>
                                <form method="POST" action="{{ url_for('profile') }}" class="space-y-4 max-w-md">
                                    <input type="hidden" name="action" value="change_password">
                                    <div>
                                        <label for="current_password" class="block mb-2 text-sm font-medium text-black dark:text-white">Senha Atual</label>
                                        <input type="password" name="current_password" id="current_password" class="flex w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-black/30 px-3 py-2 text-sm shadow-inner placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-black dark:text-white" required>
                                    </div>
                                    <div>
                                        <label for="new_password" class="block mb-2 text-sm font-medium text-black dark:text-white">Nova Senha</label>
                                        <input type="password" name="new_password" id="new_password" class="flex w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-black/30 px-3 py-2 text-sm shadow-inner placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-black dark:text-white" required>
                                    </div>
                                    <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium h-10 px-4 py-2 bg-blue-600 text-white hover:bg-blue-700">Alterar Senha</button>
                                </form>
                            </div>

                            <!-- Formulário de Configuração de SMTP -->
                            <div class="border-t border-gray-200 dark:border-gray-700/50 pt-6">
                                <h3 class="text-lg font-semibold text-black dark:text-white mb-4">Configuração de SMTP (Gmail)</h3>
                                <form method="POST" action="{{ url_for('profile') }}" class="space-y-4 max-w-md">
                                    <input type="hidden" name="action" value="update_smtp">
                                    <div>
                                        <label for="gmail_email" class="block mb-2 text-sm font-medium text-black dark:text-white">Seu Email do Gmail</label>
                                        <input type="email" name="gmail_email" id="gmail_email" value="{{ current_user.gmail_email or '' }}" class="flex w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-black/30 px-3 py-2 text-sm shadow-inner placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-black dark:text-white" required>
                                    </div>
                                    <div>
                                        <label for="gmail_app_password" class="block mb-2 text-sm font-medium text-black dark:text-white">Nova Senha de App (deixe em branco para não alterar)</label>
                                        <input type="password" name="gmail_app_password" id="gmail_app_password" class="flex w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-black/30 px-3 py-2 text-sm shadow-inner placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-black dark:text-white">
                                    </div>
                                    <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium h-10 px-4 py-2 bg-blue-600 text-white hover:bg-blue-700">Salvar Configuração SMTP</button>
                                </form>
                            </div>

                            <!-- Formulário de Excluir Conta -->
                            <div class="border-t border-red-300 dark:border-red-500/30 pt-6">
                                <h3 class="text-lg font-semibold text-red-600 dark:text-red-400 mb-4">Zona de Perigo</h3>
                                <form method="POST" action="{{ url_for('delete_account') }}" onsubmit="return confirm('Você tem certeza ABSOLUTA que deseja excluir sua conta? Todos os seus dados serão perdidos permanentemente. Esta ação não pode ser desfeita.');" class="space-y-4 max-w-md">
                                    <p class="text-sm text-black dark:text-white">Para excluir sua conta, por favor, digite sua senha atual. Esta ação é irreversível.</p>
                                    <div>
                                        <label for="password_confirm_delete" class="block mb-2 text-sm font-medium text-black dark:text-white">Sua Senha</label>
                                        <input type="password" name="password" id="password_confirm_delete" class="flex w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-black/30 px-3 py-2 text-sm shadow-inner placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-black dark:text-white" required>
                                    </div>
                                    <button type="submit" class="w-full h-10 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Excluir Minha Conta Permanentemente</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='script.js') }}"></script>
{% endblock %}
